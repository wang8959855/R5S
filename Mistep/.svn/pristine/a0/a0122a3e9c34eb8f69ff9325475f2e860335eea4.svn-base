//
//  RgistViewController.m
//  keyband
//
//  Created by 迈诺科技 on 15/10/28.
//  Copyright © 2015年 mainuo. All rights reserved.
//

#import "RgistViewController.h"
#import "LoginViewController.h"
#import "EditPersonInformationViewController.h"

@interface RgistViewController ()
{
    BOOL keyBoard;
}
@end

@implementation RgistViewController

- (void)dealloc
{
}
-(void)viewDidAppear:(BOOL)animated
{
    [super viewDidAppear:YES];
    [[PSDrawerManager instance] cancelDragResponse];
}

- (void)viewDidLoad {
    [super viewDidLoad];
    [self setXibLabel];
    // Do any additional setup after loading the view from its nib.
    [self setButtonWithButton:_nextBtn andTitle:NSLocalizedString(@"下一步", nil)];
}

- (void)setXibLabel
{
    _titleLabel.text = NSLocalizedString(@"注册", nil);
    _userNameTF.placeholder = NSLocalizedString(@"请输入帐号", nil);
    _passWordTF.placeholder = NSLocalizedString(@"请输入密码", nil);
    _passWordSureTF.placeholder = NSLocalizedString(@"请输入密码", nil);
    _emailTF.placeholder = NSLocalizedString(@"请输入邮箱", nil);
    _kUserNameLabel.text = NSLocalizedString(@"帐号", nil);
    _kPasswordLabel.text = NSLocalizedString(@"密码", nil);
    _kPassworkSureLabel.text = NSLocalizedString(@"确认密码", nil);
    _kEmailLabel.text = NSLocalizedString(@"邮箱", nil);
}

#pragma mark - 按钮点击事件
- (IBAction)gobackClick:(id)sender
{
    [HCHCommonManager getInstance].userInfoDictionAry = nil;
    [self.navigationController popViewControllerAnimated:YES];
}
-(void)nextButton
{
    _nextBtn.userInteractionEnabled = YES;
}
- (IBAction)nextPage:(id)sender
{
    _nextBtn.userInteractionEnabled = NO;
    [self performSelector:@selector(nextButton) withObject:nil afterDelay:2.0f];
    [self.view endEditing:YES];
    if ([self checkUserName:_userNameTF.text])
    {
        if ([self checkPassWord:_passWordTF.text])
        {
            if([self checkPassWordTwo])
            {
                if([self checkEmail:_emailTF.text])
                {
                    NSMutableDictionary *validationDictionary = [[NSMutableDictionary alloc]initWithObjectsAndKeys:_userNameTF.text,@"user.account",_emailTF.text,@"user.email",nil];
                    
                    WeakSelf;
                    [[AFAppDotNetAPIClient sharedClient] globalmultiPartUploadWithUrl:@"user_validation" fileUrl:nil params:validationDictionary Block:^(id responseObject, NSError *error) {
                        
                        //adaLog(@"responseObject[msg] - %@",responseObject[@"msg"]);
                        //adaLog(@"responseObject - %@",responseObject);
                        //adaLog(@"error - %@",error);
                        if (error)
                        {
                            [weakSelf removeActityIndicatorFromView:weakSelf.view];
                            [weakSelf addActityTextInView:self.view text:NSLocalizedString(@"服务器异常", ni) deleyTime:1.5f];
                        }else
                        {
                            
                            int code = [[responseObject objectForKey:@"code"] intValue];
                            if (code == 9003)
                            {
                                //                                UIWindow *window = [UIApplication sharedApplication].keyWindow;
                                //                                [weakSelf addActityTextInView:window text:NSLocalizedString(@"此帐号可以注册", nil) deleyTime:1.5f];
                                NSMutableDictionary *registDictionary = [[NSMutableDictionary alloc]initWithObjectsAndKeys:
                                                                         _userNameTF.text,@"user.account",
                                                                         [_passWordTF.text md5_32],@"user.password",
                                                                         _emailTF.text,@"user.email",nil];
                                EditPersonInformationViewController *editVC = [EditPersonInformationViewController new];
                                editVC.userInfo = registDictionary;
                                editVC.isEdit = YES;
                                editVC.isRegister = YES;
                                editVC.EditState = EditPersonStateRegist;
                                if (_userCacheInfo)
                                {
                                    editVC.userCacheInfo = _userCacheInfo;
                                }
                                [self.navigationController pushViewController:editVC animated:YES];
                                
                            }
                            else if(code == 100)
                            {
                                UIAlertController *alert = [UIAlertController alertControllerWithTitle:@"此帐号已注册" message:@"" preferredStyle:UIAlertControllerStyleAlert];
                                [self presentViewController:alert animated:YES completion:nil];
                                [self performSelector:@selector(dimissAlertController:) withObject:alert afterDelay:1.5];
                                
                                //                            [weakSelf addActityTextInView:weakSelf.view text:NSLocalizedString(@"此帐号已注册", nil) deleyTime:0.5f];
                                [self performSelector:@selector(TFBecomeFirstResponder:) withObject:_userNameTF afterDelay:1];
                            }
                            else if(code == 101)
                            {
                                UIAlertController *alert = [UIAlertController alertControllerWithTitle:@"此邮箱已注册" message:@"" preferredStyle:UIAlertControllerStyleAlert];
                                [self presentViewController:alert animated:YES completion:nil];
                                [self performSelector:@selector(dimissAlertController:) withObject:alert afterDelay:1.5];
                                [self performSelector:@selector(TFBecomeFirstResponder:) withObject:_emailTF afterDelay:1];
                                
                            }
                        }
                    }];
                }
                else
                {
                    [self performSelector:@selector(TFBecomeFirstResponder:) withObject:_emailTF afterDelay:1];
                }
            }else
            {
                [self performSelector:@selector(TFBecomeFirstResponder:) withObject:_passWordSureTF afterDelay:1];
            }
            
        }
        else
        {
            [self performSelector:@selector(TFBecomeFirstResponder:) withObject:_passWordTF afterDelay:1];
        }
    }
    else
    {
        [self performSelector:@selector(TFBecomeFirstResponder:) withObject:_userNameTF afterDelay:1];
    }
}
- (BOOL) checkPassWordTwo
{
    BOOL flag = YES;
    if ([_passWordTF.text isEqualToString:_passWordSureTF.text])
    {
        flag = YES;
    }
    else
    {
        flag = NO;
        [self showAlertView:NSLocalizedString(@"您两次输入的密码不一致", nil) ];
    }
    
    return flag;
}
#pragma mark - TF获得第一响应
- (void)TFBecomeFirstResponder:(UITextField *)textField
{
    [textField becomeFirstResponder];
}

- (IBAction)didEndEdit:(UITextField *)sender
{
    [self.view endEditing:YES];
}


- (IBAction)TFDidChanged:(UITextField *)sender {
    bool isOK = NO;
    switch (sender.tag)
    {
        case 50:
            isOK = [self isUserName:_userNameTF.text]?YES:NO;
            break;
        case 51:
            isOK = [self isPassWord:_passWordTF.text]?YES:NO;
            break;
        case 52:
            isOK = [self isEmail:_emailTF.text]?YES:NO;
            break;
        default:
            break;
    }
    if (isOK)
    {
        UIImageView *imageView = [self.view viewWithTag:sender.tag+100];
        if ([imageView isKindOfClass:[UIImageView class]])
            imageView.image = [UIImage imageNamed:@"ZC_OK"];
    }else
    {
        UIImageView *imageView = [self.view viewWithTag:sender.tag+100];
        if ([imageView isKindOfClass:[UIImageView class]])
            imageView.image = [UIImage imageNamed:@"ZC_NotOK"];
    }
}

- (void)touchesBegan:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event
{
    [self.view endEditing:YES];
}

- (void)keyBoardWillShow:(NSNotification *)notification
{
    if (keyBoard)
    {
        return;
    }
    else
    {
        CGPoint center = self.view.center;
        center.y -= 216;
        [UIView animateWithDuration:0.27 animations:^{
            self.view.center = center;
        }];
        keyBoard = YES;
    }
}

- (void)keyBoardWillHiden:(NSNotification *)notification
{
    [UIView animateWithDuration:0.25 animations:^{
        self.view.center = CurrentDeviceCenter;
    }];
    keyBoard = NO;
}
-(void)dimissAlertController:(UIAlertController *)alert {
    if(alert)
    {
        [alert dismissViewControllerAnimated:YES completion:nil];
    }
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

/*
 #pragma mark - Navigation
 
 // In a storyboard-based application, you will often want to do a little preparation before navigation
 - (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
 // Get the new view controller using [segue destinationViewController].
 // Pass the selected object to the new view controller.
 }
 */

@end
